<?php
 defined("\x41\x42\x53\x50\x41\124\x48") || die; trait Virtuaria_PagSeguro_DuoPay { public function init_form_fields() { $pix_options = $this->get_pix_default_settings(); unset($pix_options["\x70\151\x78\137\x64\x69\163\143\157\x75\156\164"]); unset($pix_options["\160\151\x78\137\x64\x69\x73\143\x6f\165\x6e\x74\137\143\x6f\x75\160\157\156"]); unset($pix_options["\160\151\170\x5f\x64\151\163\143\157\165\x6e\x74\x5f\x69\147\x6e\157\162\x65"]); $pix_options["\160\151\170\x5f\166\141\154\151\x64\141\164\x65"]["\x6f\x70\164\151\x6f\156\x73"]["\62\x31\x36\x30\60"] = __("\x36\40\150\157\x75\162\163", "\x76\151\x72\x74\x75\x61\x72\x69\141\x2d\x70\141\147\x73\x65\x67\165\x72\157"); $pix_options["\160\x69\x78\137\x76\x61\x6c\151\x64\x61\x74\145"]["\x6f\160\164\x69\x6f\x6e\x73"]["\x34\63\62\60\60"] = __("\61\62\x20\150\157\165\162\163", "\166\x69\x72\x74\x75\141\162\151\x61\55\x70\x61\x67\163\x65\147\x75\x72\157"); $this->form_fields = $this->get_default_settings() + array("\x6d\151\x6e\137\160\x65\162\x63\x65\x6e\164\x5f\143\x72\145\x64\151\x74" => array("\164\151\164\154\x65" => __("\x4d\151\x6e\40\x70\145\162\143\145\156\x74\x20\143\x72\145\x64\x69\x74\x20\x28\x25\x29", "\166\x69\x72\x74\x75\141\x72\151\141\x2d\x70\x61\147\x73\x65\147\165\x72\157"), "\164\x79\160\145" => "\x6e\x75\155\142\x65\x72", "\144\145\x73\143\162\x69\160\x74\x69\157\156" => __("\x44\x65\146\x69\x6e\145\x20\164\150\x65\40\155\151\156\151\155\165\x6d\40\160\x65\162\x63\145\x6e\x74\40\x74\x6f\x20\142\x65\40\x70\141\151\x64\40\142\x79\40\143\x72\145\x64\151\164\x20\x63\x61\162\x64", "\166\x69\162\164\x75\141\162\x69\x61\55\160\x61\x67\x73\145\x67\165\x72\x6f"), "\144\145\x66\x61\165\154\x74" => "\x31\x30", "\144\x65\163\x63\x5f\164\x69\160" => true, "\x63\x75\163\x74\157\155\137\x61\164\x74\162\151\x62\165\x74\145\163" => array("\x6d\151\156" => "\x31", "\155\x61\x78" => "\x39\71", "\163\x74\x65\160" => "\x30\56\60\x31")), "\x6d\141\170\137\160\x65\x72\x63\145\x6e\164\x5f\143\x72\x65\144\151\x74" => array("\x74\151\164\x6c\145" => __("\115\x61\x78\40\x70\x65\162\x63\145\156\x74\40\143\162\145\x64\151\x74\40\50\45\51", "\x76\x69\162\x74\x75\141\x72\151\141\x2d\x70\141\x67\x73\x65\147\165\162\x6f"), "\164\x79\x70\145" => "\156\165\x6d\x62\x65\x72", "\144\x65\163\x63\162\x69\160\x74\x69\x6f\x6e" => __("\x44\145\146\151\156\x65\x20\164\150\x65\x20\x6d\x61\x78\x69\x6d\x75\x6d\x20\x70\145\162\143\145\x6e\x74\x20\x74\x6f\40\x62\145\x20\160\141\151\x64\x20\142\171\x20\143\162\x65\x64\x69\x74\40\x63\x61\x72\x64", "\166\x69\x72\164\165\x61\162\151\141\55\160\x61\x67\x73\145\x67\x75\162\157"), "\x64\x65\146\141\165\154\164" => "\x39\x30", "\x64\x65\x73\143\137\x74\151\160" => true, "\x63\165\163\x74\x6f\x6d\x5f\141\164\x74\x72\151\142\x75\164\x65\163" => array("\x6d\x69\156" => "\61", "\155\x61\170" => "\71\71", "\163\164\x65\160" => "\x30\x2e\60\x31"))) + $pix_options + $this->get_credit_default_settings(); } public function displays_choice_total_paid_credit($method_id) { if ($this->id !== $method_id) { return; } $total = $this->get_order_total(); $min = $this->get_min_credit_value($total); $max = $this->get_max_credit_value($total); $choose = $this->get_choose_total_duopay($min, $max); require VIRTUARIA_PAGSEGURO_DIR . "\164\x65\x6d\160\x6c\x61\164\145\x73\57\143\x68\157\151\x63\145\x2d\164\x6f\x74\141\x6c\55\x70\141\x69\144\56\x70\150\x70"; } public function get_choose_total_duopay($min, $max) { $choose = isset(WC()->session) ? WC()->session->get("\x76\151\162\x74\x75\141\162\x69\141\x5f\x70\141\x67\163\145\x67\x75\x72\157\x5f\144\165\157\x70\141\x79\x5f\x63\x72\145\x64\151\164\137\x76\x61\154\x75\x65") : null; if (!$choose || $choose < $min || $choose > $max) { $choose = ($max + $min) / 2; if (isset(WC()->session)) { WC()->session->set("\166\151\162\x74\165\141\162\151\141\x5f\160\x61\147\x73\x65\x67\x75\162\157\137\144\x75\x6f\x70\141\171\137\x63\162\x65\144\x69\164\137\x76\x61\154\165\145", $choose); } } return $choose; } public function save_choose_duopay_credit_total($post_data) { parse_str($post_data, $post_data_array); if (isset($post_data_array["\166\151\x72\164\165\x61\162\x69\141\137\x70\x61\x67\x73\x65\x67\165\162\x6f\137\x64\165\157\x70\141\171\137\x63\162\x65\x64\151\x74\137\166\x61\154\x75\145"]) && isset(WC()->session)) { WC()->session->set("\166\151\162\164\x75\x61\x72\151\141\137\160\x61\147\x73\x65\147\165\x72\157\x5f\x64\x75\157\160\x61\171\137\143\x72\145\x64\151\164\137\166\141\x6c\165\145", floatval($post_data_array["\x76\151\x72\164\165\x61\x72\151\141\137\x70\141\x67\163\145\x67\x75\162\157\x5f\x64\x75\x6f\x70\141\x79\x5f\143\x72\145\x64\151\164\137\166\141\154\x75\x65"])); } } public function duopay_admin_scripts() { if (isset($_GET["\160\x6f\163\164"])) { $order = wc_get_order(sanitize_text_field(wp_unslash($_GET["\160\157\x73\164"]))); } elseif (isset($_GET["\151\x64"])) { $order = wc_get_order(sanitize_text_field(wp_unslash($_GET["\x69\x64"]))); } if (isset($order) && $order) { wp_enqueue_script("\166\x69\x72\x74\x75\x61\162\151\x61\x2d\x70\141\x67\163\145\147\x75\162\157\55\x64\x75\157\x70\141\171\55\141\x64\155\151\x6e", VIRTUARIA_PAGSEGURO_URL . "\x61\x64\x6d\x69\x6e\x2f\152\163\x2f\144\x75\157\x70\141\x79\x2d\x6f\x72\x64\x65\162\x2e\x6a\163", array("\152\161\165\145\x72\171"), filemtime(VIRTUARIA_PAGSEGURO_DIR . "\x61\144\155\x69\x6e\57\152\x73\x2f\144\165\x6f\x70\x61\171\55\x6f\162\x64\x65\162\56\x6a\163"), true); wp_localize_script("\166\151\162\164\x75\x61\162\151\141\55\160\141\x67\163\145\147\x75\x72\157\x2d\x64\165\x6f\160\141\x79\x2d\141\144\155\x69\156", "\x76\x69\162\x74\x75\141\162\151\141\x5f\x70\141\147\x73\145\x67\165\x72\157\x5f\x69\156\x66\x6f", array("\x61\152\141\170\137\x75\162\154" => admin_url("\x61\x64\x6d\x69\156\55\141\x6a\x61\170\x2e\x70\150\160"))); wp_enqueue_style("\x76\x69\x72\x74\x75\141\x72\151\141\x2d\160\141\147\x73\145\147\x75\162\157\x2d\144\165\x6f\x70\x61\171\55\141\x64\x6d\x69\156", VIRTUARIA_PAGSEGURO_URL . "\141\x64\x6d\151\156\57\x63\163\x73\x2f\x64\165\x6f\x70\141\171\x2d\x6f\x72\x64\x65\x72\56\143\x73\x73", array(), filemtime(VIRTUARIA_PAGSEGURO_DIR . "\141\144\x6d\151\156\x2f\x63\x73\163\x2f\144\165\x6f\x70\x61\x79\55\157\162\144\145\x72\56\x63\x73\x73")); } } private function get_min_credit_value($total) { return number_format($total * $this->min_percent_credit, 2, "\56", ''); } private function get_max_credit_value($total) { return number_format($total * $this->max_percent_credit, 2, "\56", ''); } public function total_refund_fallbak_transactions_box($post_or_order) { $order = $this->get_order_from_mixed($post_or_order); if ($order->get_payment_method() !== $this->id) { return; } add_meta_box("\x76\151\x72\x74\165\x61\x72\151\141\x2d\x70\141\147\x73\x65\x67\165\x72\x6f\x2d\x72\145\x66\x75\156\x64\x73", __("\126\151\x72\164\x75\x61\x72\x69\141\x20\x50\x61\147\x53\x65\147\x75\x72\157\72\x20\x52\x65\146\x75\x6e\x64\163", "\166\151\x72\x74\x75\x61\x72\x69\x61\x2d\160\x61\x67\163\x65\x67\165\162\157"), array($this, "\162\x65\146\165\x6e\144\x5f\146\x61\x6c\x6c\142\141\143\x6b\x5f\164\162\x61\x6e\x73\141\143\x74\x69\157\156\163"), $this->get_meta_boxes_screen(), "\x6e\157\x72\155\141\154", "\x63\x6f\162\x65"); } public function refund_fallback_transactions($post_or_order) { $order = $this->get_order_from_mixed($post_or_order); if ($order) { $transactions = $order->get_meta("\x5f\x64\x75\x6f\x70\x61\171\x5f\x74\x72\x61\156\163\141\143\x74\x69\x6f\156\x73", true); if ($transactions) { require_once VIRTUARIA_PAGSEGURO_DIR . "\x74\145\155\x70\154\x61\x74\145\163\57\x72\x65\146\165\156\144\55\x66\141\x6c\x6c\x62\141\143\x6b\55\164\162\141\156\x73\x61\143\164\x69\157\156\x73\56\x70\x68\x70"; return; } } printf("\x3c\x70\x3e\x25\x73\x3c\x2f\x70\x3e", esc_html__("\x4e\x6f\40\x74\x72\x61\x6e\163\x61\x63\x74\151\157\156\x73\40\x66\x6f\x75\x6e\144\x2e", "\166\151\x72\x74\165\141\162\x69\141\x2d\x70\x61\x67\163\145\147\165\x72\x6f")); } public function duopay_fallback_refund_order() { if (isset($_POST["\x6f\162\x64\145\x72\x5f\x69\x64"], $_POST["\156\x6f\156\143\x65"], $_POST["\143\x68\141\x72\147\145\x5f\x69\144"], $_POST["\141\155\157\x75\x6e\x74"], $_POST["\164\171\160\x65"]) && wp_verify_nonce(sanitize_text_field(wp_unslash($_POST["\x6e\157\156\x63\x65"])), "\x66\x61\154\154\x62\141\x63\153\x2d\146\x75\154\x6c\55\x72\145\x66\165\156\x64")) { $charge_id = sanitize_text_field(wp_unslash($_POST["\143\x68\x61\x72\x67\145\137\x69\x64"])); $order_id = intval($_POST["\x6f\162\x64\x65\162\x5f\x69\144"]); $amount = floatval($_POST["\x61\155\157\165\156\164"]); $order = wc_get_order($order_id); $type = sanitize_text_field(wp_unslash($_POST["\x74\x79\x70\145"])); if (strlen($charge_id) > 0 && $amount > 0 && $order && $this->process_refund($order_id, number_format($amount, 2, "\56", "\54"), __("\x52\145\x66\x75\156\x64\x20\x52\145\161\165\x65\163\164", "\166\151\x72\164\165\x61\x72\x69\x61\x2d\160\x61\x67\x73\x65\147\x75\x72\x6f"), $type, $charge_id)) { $this->update_refunded_values($order, $amount, $type); echo "\163\x75\143\x63\x65\163\163"; } } wp_die(); } private function update_refunded_values($order, $amount, $type) { $total_method_refunded = floatval($order->get_meta("\x5f\x64\165\x6f\160\x61\171\x5f\x72\x65\146\165\156\x64\x5f" . $type)); $total_method_refunded += $amount; $order->update_meta_data("\x5f\x64\165\x6f\x70\141\171\137\x72\145\x66\165\156\x64\137" . $type, $total_method_refunded); $total_refunded = floatval($order->get_meta("\137\144\x75\157\160\x61\171\x5f\164\157\164\x61\154\137\162\x65\146\165\x6e\144\145\144")); $total_refunded += $amount; $order->update_meta_data("\137\x64\165\x6f\160\141\x79\137\x74\157\x74\141\x6c\x5f\162\x65\146\x75\156\144\x65\x64", $total_refunded); if ($total_refunded >= $order->get_total()) { $order->set_status("\162\x65\x66\x75\x6e\x64\x65\144"); } $transaction_id = $order->get_meta("\x5f\144\x75\157\x70\x61\x79\137{$type}\137\164\162\141\156\x73\141\x63\x74\151\x6f\156\x5f\x69\144"); $transactions = $order->get_meta("\x5f\144\x75\157\x70\141\x79\x5f\164\x72\141\x6e\163\x61\143\164\151\157\156\x73"); if ($transactions && isset($transactions[$transaction_id])) { $transactions[$transaction_id]["\x72\x65\x66\165\x6e\x64\145\144"] = $total_method_refunded; $order->update_meta_data("\137\144\x75\x6f\x70\141\x79\x5f\x74\162\141\156\x73\x61\x63\164\x69\157\x6e\163", $transactions); } $order->save(); } public function set_choose_duopay_credit_total() { if (isset($_POST["\x74\157\164\x61\x6c"], $_POST["\x6e\x6f\x6e\143\x65"]) && wp_verify_nonce(sanitize_text_field(wp_unslash($_POST["\x6e\x6f\156\x63\145"])), "\144\x6f\137\156\x65\x77\x5f\143\150\x61\x72\147\145") && isset(WC()->session)) { $total = floatval($_POST["\x74\x6f\x74\141\154"]); $order_total = $this->get_order_total(); if ($total >= $this->get_min_credit_value($order_total) && $total <= $this->get_max_credit_value($order_total)) { WC()->session->set("\x76\x69\x72\x74\x75\x61\162\x69\141\x5f\x70\x61\x67\x73\145\x67\165\162\x6f\137\x64\165\x6f\x70\141\171\137\x63\x72\x65\x64\151\x74\x5f\166\x61\x6c\165\x65", floatval($_POST["\x74\x6f\x74\x61\x6c"])); wp_send_json_success("\x73\165\x63\x63\145\x73\x73"); } } wp_die(); } public function display_pix_current_total($order_id) { $order = wc_get_order($order_id); if ($order) { $pix_total = $order->get_meta("\137\144\x75\x6f\160\141\171\x5f\x70\151\170\137\143\x68\141\x72\x67\145\x5f\164\157\x74\141\x6c", true); if ($pix_total) { printf("\74\160\x20\143\x6c\x61\x73\x73\x3d\42\x64\165\x6f\x70\x61\x79\x2d\x70\x69\x78\x2d\164\x6f\164\141\154\x22\x3e\45\163\72\x20\x3c\x73\164\x72\x6f\x6e\147\x3e\x25\163\x3c\57\x73\164\x72\157\x6e\x67\76\x3c\57\x70\76", esc_html__("\124\x6f\x74\141\154\x20\x64\157\40\120\151\x78", "\x76\151\x72\x74\x75\x61\162\x69\x61\55\160\141\147\x73\145\147\165\162\x6f"), wp_kses_post(wc_price($pix_total))); } } } }